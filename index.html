<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Discord DM Bot</title>
<link href="https://fonts.googleapis.com/css2?family=Maven+Pro&display=swap" rel="stylesheet">
<style>
body { font-family: Arial,sans-serif; background:#fff; color:#000; padding:20px;}
h1 { font-family:'Maven Pro',sans-serif; color:#ce0f2d;}
label { font-weight:bold; }
textarea,input,select{width:100%;padding:8px;margin:5px 0;}
button{background:#ce0f2d;color:#fff;border:none;padding:10px 20px;cursor:pointer;font-weight:bold;}
button:disabled{background:#aaa; cursor:not-allowed;}
button:hover:not(:disabled){background:#a50b20;}
.section{border:1px solid #ce0f2d; padding:10px; margin-bottom:20px;}
.embedPreview{border:1px solid #ccc;padding:10px;margin-top:10px;background:#f9f9f9;}
.embed-title{font-weight:bold;color:#ce0f2d;}
</style>
</head>
<body>

<h1>Discord DM Bot IBPróxima</h1>

<div class="section">
<label>Tipo de envío:</label>
<select id="sendType">
<option value="single">Usuario</option>
<option value="all">Todos</option>
<option value="role">Rol específico</option>
</select>

<div id="singleDiv">
<label>ID del usuario:</label>
<input type="text" id="userId">
</div>

<div id="roleDiv" style="display:none;">
<label>Selecciona un rol:</label>
<select id="roleName"></select>
</div>

<label>Mensaje normal (opcional):</label>
<textarea id="message"></textarea>
</div>

<div class="section" id="embedsContainer">
<h2 style="color:#ce0f2d;font-family:'Maven Pro';">Embeds</h2>
</div>
<button id="addEmbed">+ Añadir Embed</button>

<div class="section">
<button id="sendBtn">Enviar</button>
<p id="status"></p>
<h3>Progreso de envío:</h3>
<p id="progress">0 / 0</p>
</div>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
const sendType=document.getElementById("sendType");
const roleDiv=document.getElementById("roleDiv");
const singleDiv=document.getElementById("singleDiv");
const sendBtn=document.getElementById("sendBtn");
const progress=document.getElementById("progress");

sendType.addEventListener("change",()=>{roleDiv.style.display=sendType.value==="role"?"block":"none"; singleDiv.style.display=sendType.value==="single"?"block":"none";});

// Cargar roles
async function loadRoles(){
  const res=await fetch("/get-roles");
  const roles=await res.json();
  const select=document.getElementById("roleName");
  roles.forEach(r=>{const opt=document.createElement("option"); opt.value=r; opt.text=r; select.appendChild(opt);});
}
loadRoles();

// Manejo de múltiples embeds
let embedCount=0;
const container=document.getElementById("embedsContainer");
document.getElementById("addEmbed").addEventListener("click",()=>{
  embedCount++;
  const div=document.createElement("div");
  div.className="section";
  div.innerHTML=`
    <h3>Embed ${embedCount}</h3>
    <label>Author Name:</label><input type="text" class="authorName">
    <label>Author URL:</label><input type="text" class="authorURL">
    <label>Author Icon URL:</label><input type="text" class="authorIcon">
    <label>Title:</label><input type="text" class="title">
    <label>URL (del título):</label><input type="text" class="url">
    <label>Description:</label><textarea class="description"></textarea>
    <label>Color (HEX):</label><input type="text" class="color" placeholder="#ce0f2d">
    <label>Thumbnail URL:</label><input type="text" class="thumbnail">
    <label>Image URL:</label><input type="text" class="image">
    <label>Footer:</label><input type="text" class="footer">
    <label>Footer Icon URL:</label><input type="text" class="footerIcon">
    <label>Timestamp (YYYY-MM-DD hh:mm):</label><input type="text" class="timestamp">
  `;
  container.appendChild(div);
});

// Conexión WebSocket para progreso
const socket = io();
socket.on("updateProgress", data => {
  progress.innerText = `${data.sent} / ${data.total} usuarios`;
});

// Enviar mensaje con cooldown botón 20s
sendBtn.addEventListener("click", async()=>{
  sendBtn.disabled=true;
  setTimeout(()=>sendBtn.disabled=false,20000);

  const type=sendType.value;
  const userId=document.getElementById("userId").value;
  const roleName=document.getElementById("roleName").value;
  const message=document.getElementById("message").value;

  const embeds=[];
  document.querySelectorAll("#embedsContainer > div").forEach(div=>{
    embeds.push({
      authorName: div.querySelector(".authorName").value,
      authorURL: div.querySelector(".authorURL").value,
      authorIcon: div.querySelector(".authorIcon").value,
      title: div.querySelector(".title").value,
      url: div.querySelector(".url").value,
      description: div.querySelector(".description").value,
      color: div.querySelector(".color").value,
      thumbnail: div.querySelector(".thumbnail").value,
      image: div.querySelector(".image").value,
      footer: div.querySelector(".footer").value,
      footerIcon: div.querySelector(".footerIcon").value,
      timestamp: div.querySelector(".timestamp").value
    });
  });

  const payload={sendType:type,userId,roleName,message,embeds};
  try{
    const res=await fetch("/send-dm",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
    document.getElementById("status").innerText=await res.text();
  }catch(e){document.getElementById("status").innerText="❌ Error: "+e.message;}
});
</script>
</body>
</html>
